# Review Report — td-bf126c (2026-01-31)

## Scope
- Reviewed closed tasks in epic **td-bf126c** against `docs/sync-plan-03-merged.md` and `docs/sync-mvp-testing-spec.md`.
- Examined implementation in `internal/sync`, `internal/api`, `internal/serverdb`, `cmd/`, and sync docs.
- Ran full test suite and spot-checked sync harness + client/server flows.

## Tests Run
```bash
go test ./...
```

## Fixes Applied (this review)
- **Session concurrency**: guarded `session.GetOrCreate` with a mutex to prevent concurrent callers creating divergent sessions. This fixes `TestConcurrentMigration` failure in `internal/session` and makes session creation deterministic under parallel access.

Files changed:
- `internal/session/session.go`

## Findings vs Spec
### High-priority correctness gaps
1. **Crash-recovery retries leave duplicate events permanently pending**
   - If a push succeeds but the client doesn’t mark action_log rows synced (crash/network), the retry is rejected as `duplicate` and those rows remain unsynced forever. This causes infinite re-push attempts.
   - Affects v1 reliability for crash recovery / flaky connections.

2. **Sync apply fails for array/object payload fields**
   - `ApplyRemoteEvents` → `upsertEntity` passes JSON arrays/maps (e.g., issue labels, handoff sections) directly into SQLite, which errors on unsupported types. This breaks sync for issues with labels and any handoff payload.

3. **Handoff creations are not logged to action_log**
   - Primary handoffs and work-session handoffs never create action_log entries (only cascaded handoffs do), so they never push despite docs claiming handoffs sync.

### Spec mismatches / incomplete phase items
4. **Conflict detection is overly broad**
   - Conflicts are recorded whenever a row already exists, not only when local edits happened since last sync (as documented). This can over-report and pollute `sync_conflicts`.

5. **Phase 2 snapshot bootstrap missing**
   - No `/sync/snapshot` endpoint or client bootstrap flow is implemented despite Phase 2 task being closed.

6. **Auto-sync triggers missing**
   - Startup/periodic/debounce auto-sync is not implemented; sync remains fully manual.

## Tickets Created (epic: td-bf126c)
- **td-9e2e3a** — Sync push retry leaves duplicate events permanently pending
- **td-c995ba** — Sync apply fails on array/object payload fields (labels, handoff sections)
- **td-aae070** — Handoff creations are not logged to action_log (never sync)
- **td-681716** — Conflict detection flags every overwrite (not just local changes since last sync)
- **td-f06f29** — Phase 2 snapshot bootstrap endpoint/client support missing
- **td-88b016** — Auto-sync triggers not implemented (startup/periodic/debounce)

## Notes
- Core sync library and server API generally align with v3 spec and MVP tests, and the full test suite now passes after the session concurrency fix.
- The items above are the main blockers to “fully functional” v1 sync as documented.
